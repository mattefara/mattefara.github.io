<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Homelab journey Blog</title>
        <link>https://mattefara.github.com/blog/</link>
        <description>Homelab journey Blog</description>
        <lastBuildDate>Fri, 07 Jun 2024 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Reloading credentials in legacy applications with Vault and Wave]]></title>
            <link>https://mattefara.github.com/blog/Wave/</link>
            <guid>https://mattefara.github.com/blog/Wave/</guid>
            <pubDate>Fri, 07 Jun 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[This article discusses the automation of credential rotation with Vault for applications that do not natively support it. The complete repository can be found here.]]></description>
            <content:encoded><![CDATA[<p>This article discusses the automation of credential rotation with Vault for applications that do not natively support it. The complete repository can be found <a href="https://github.com/mattefara/k8s-wave-test" target="_blank" rel="noopener noreferrer">here</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-tools">Introduction to Tools<a href="https://mattefara.github.com/blog/Wave/#introduction-to-tools" class="hash-link" aria-label="Direct link to Introduction to Tools" title="Direct link to Introduction to Tools">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vault">Vault<a href="https://mattefara.github.com/blog/Wave/#vault" class="hash-link" aria-label="Direct link to Vault" title="Direct link to Vault">​</a></h3>
<p>One of the appealing features of Vault is the <a href="https://developer.hashicorp.com/vault/tutorials/db-credentials/database-secrets" target="_blank" rel="noopener noreferrer">dynamic secrets</a>.
These types of credentials are automatically rotated after a fixed period, such as database credentials.</p>
<p>Typically, applications must support this feature, which means that there is often an integration with Vault at the application layer.
In other words, the application itself must support Vault.</p>
<p>Vault offers another type of integration with init containers and sidecars.
Specifically, with the sidecar, the application must reload its configuration after the credential rotation, but this feature is not always supported.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="wave">Wave<a href="https://mattefara.github.com/blog/Wave/#wave" class="hash-link" aria-label="Direct link to Wave" title="Direct link to Wave">​</a></h3>
<p><code>Wave monitors Deployments, StatefulSets, and DaemonSets within a Kubernetes cluster and ensures that their Pods always have up-to-date configuration.</code>
Wave introduces itself with this statement and can be useful in this case.
When a configuration changes, Wave performs a rollout strategy so that the application can use new configurations.</p>
<p>At this point, what is missing is something that can update Secrets with the values in Vault, keeping them synchronized.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="external-secret-operator-eso">External Secret Operator (ESO)<a href="https://mattefara.github.com/blog/Wave/#external-secret-operator-eso" class="hash-link" aria-label="Direct link to External Secret Operator (ESO)" title="Direct link to External Secret Operator (ESO)">​</a></h3>
<p>The External Secret Operator is a tool that monitors and synchronizes Kubernetes Secrets with others from an external source.
This tool supports a variety of external sources like AWS, CPG, Vault, etc.
A list of providers can be found <a href="https://external-secrets.io/latest/provider/hashicorp-vault/" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>This tool adds the missing piece for full integration.
It is responsible for reading the credentials at time intervals from Vault and writing them as a Secret in Kubernetes.</p>
<p>To summarize: credentials can be generated from Vault and expire after a fixed amount of time, ESO requests new credentials from Vault and saves them as Secrets in Kubernetes, Wave watches these secrets and updates the Deployments using them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="hands-on">Hands-On<a href="https://mattefara.github.com/blog/Wave/#hands-on" class="hash-link" aria-label="Direct link to Hands-On" title="Direct link to Hands-On">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vault-setup">Vault Setup<a href="https://mattefara.github.com/blog/Wave/#vault-setup" class="hash-link" aria-label="Direct link to Vault Setup" title="Direct link to Vault Setup">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="installation">Installation<a href="https://mattefara.github.com/blog/Wave/#installation" class="hash-link" aria-label="Direct link to Installation" title="Direct link to Installation">​</a></h4>
<p>Vault can be installed using the <a href="https://developer.hashicorp.com/vault/docs/platform/k8s/helm#using-the-helm-chart" target="_blank" rel="noopener noreferrer">Helm Chart</a>.
For demonstration purposes, raft is disabled, using a single instance with storage as a file.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">standalone</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">      ui = true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      listener "tcp" </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tls_disable = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        address = "</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8200"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cluster_address = "</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">8201"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Enable unauthenticated metrics access (necessary for Prometheus Operator)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        telemetry </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          unauthenticated_metrics_access = "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      storage "file" </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        path = "/vault/data"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Example configuration for enabling Prometheus metrics in your config.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      telemetry </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prometheus_retention_time = "1h"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        disable_hostname = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this configuration, the application exposes metrics that can be scraped with Prometheus.</p>
<p>Also, TLS is disabled because the work can be left to services like Istio, but in this case, it is only for demonstration purposes.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-integration">Kubernetes Integration<a href="https://mattefara.github.com/blog/Wave/#kubernetes-integration" class="hash-link" aria-label="Direct link to Kubernetes Integration" title="Direct link to Kubernetes Integration">​</a></h4>
<p>Kubernetes Service Accounts can be authenticated with Vault, so they can generate database credentials with an API call. The full configuration can be found <a href="https://developer.hashicorp.com/vault/docs/auth/kubernetes#configuration" target="_blank" rel="noopener noreferrer">here</a>.</p>
<p>In this demonstration, long-lived tokens described <a href="https://developer.hashicorp.com/vault/docs/auth/kubernetes#continue-using-long-lived-tokens" target="_blank" rel="noopener noreferrer">here</a> will be used.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="database-secret-engine">Database Secret Engine<a href="https://mattefara.github.com/blog/Wave/#database-secret-engine" class="hash-link" aria-label="Direct link to Database Secret Engine" title="Direct link to Database Secret Engine">​</a></h4>
<p>Vault supports different plugins for database credential creation and rotation, and the list can be found <a href="https://developer.hashicorp.com/vault/docs/secrets/databases#database-capabilities" target="_blank" rel="noopener noreferrer">here</a>.
In this case, the <a href="https://developer.hashicorp.com/vault/docs/secrets/databases/postgresql" target="_blank" rel="noopener noreferrer">Postgres database secret engine</a> is used.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="external-secret-operator-setup">External Secret Operator Setup<a href="https://mattefara.github.com/blog/Wave/#external-secret-operator-setup" class="hash-link" aria-label="Direct link to External Secret Operator Setup" title="Direct link to External Secret Operator Setup">​</a></h3>
<p>Like Vault, ESO can be installed using a <a href="https://external-secrets.io/latest/introduction/getting-started/" target="_blank" rel="noopener noreferrer">Helm Chart</a>.
In this case, the configuration stored in the <code>values.yaml</code> file is the default.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-to-vault-and-storing-secrets">Connecting to Vault and Storing Secrets<a href="https://mattefara.github.com/blog/Wave/#connecting-to-vault-and-storing-secrets" class="hash-link" aria-label="Direct link to Connecting to Vault and Storing Secrets" title="Direct link to Connecting to Vault and Storing Secrets">​</a></h4>
<p>Firstly, a Kubernetes Service Account token is needed for the demonstration.
The service account is called Vault, and is responsible for the authentication with Vault for the generation of the dynamic secret.</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ServiceAccount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k8s</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">auth</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">kubernetes.io/service-account.name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> kubernetes.io/service</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">account</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">token</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After the service account, it's time to instruct ESO to generate secrets from Vault.
This is possible with the CRD <code>VaultDynamicSecret</code>, which defines how ESO should call the API of Vault.
In this resource, the role to use inside Vault during the generation and the Service Account requesting it are defined.
From the Vault API specifications, the API call must be made with the <code>GET</code> method.</p>
<p>The <code>ExternalSecret</code> resource, on the other hand, is used for storing the secret inside Kubernetes.
From the parameters, it is possible to specify the <code>generatorRef</code>, which is a link to the <code>VaultDynamicSecret</code> used above.</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> generators.external</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secrets.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VaultDynamicSecret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pg-secret"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/database/creds/readonly"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">method</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"GET"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">provider</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http://vault.vault.svc.cluster.local:8200"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">kubernetes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kubernetes"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">role</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"readonly"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">serviceAccountRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"vault"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> external</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secrets.io/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ExternalSecret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pg-secret-com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">refreshInterval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"2m"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">dataFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">sourceRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">generatorRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> generators.external</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secrets.io/v1alpha1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> VaultDynamicSecret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pg-secret"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After these steps, a new secret, called <code>pg-secret-com</code>, will be generated and it will have two keys called <code>username</code> and <code>password</code>.
The secret will be synchronized every <code>refreshInterval</code> time and the Kubernetes secret will be overridden.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="wave-setup">Wave Setup<a href="https://mattefara.github.com/blog/Wave/#wave-setup" class="hash-link" aria-label="Direct link to Wave Setup" title="Direct link to Wave Setup">​</a></h3>
<p>Like the other applications, Wave can be installed using its <a href="https://github.com/wave-k8s/wave" target="_blank" rel="noopener noreferrer">Helm Chart</a> and no further configuration is needed.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="watching-for-config-updates">Watching for Config Updates<a href="https://mattefara.github.com/blog/Wave/#watching-for-config-updates" class="hash-link" aria-label="Direct link to Watching for Config Updates" title="Direct link to Watching for Config Updates">​</a></h4>
<p>To instruct Wave to watch for configuration is straightforward.
The only required annotation is: <code>wave.pusher.com/update-on-config-change: "true"</code>
From now on, the Deployment will be watched and restarted every time the Secret <code>pg-secret-com</code> updates.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">wave.pusher.com/update-on-config-change</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"true"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DB_USER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DB_PASSWORD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">secretKeyRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pg</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">secret</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> password</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="load-testing-with-locust">Load Testing with Locust<a href="https://mattefara.github.com/blog/Wave/#load-testing-with-locust" class="hash-link" aria-label="Direct link to Load Testing with Locust" title="Direct link to Load Testing with Locust">​</a></h2>
<p>The configuration must be validated.
For this reason, it will be load tested using <a href="https://locust.io/" target="_blank" rel="noopener noreferrer">Locust</a>.</p>
<p>Locust is a load testing tool that is really simple to start with.
The configuration is written in Python.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> locust </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> FastHttpUser</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> between</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">WebsiteUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FastHttpUser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token decorator annotation punctuation" style="color:#393A34">@task</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this case, performance is not important but failures are.</p>
<p><img decoding="async" loading="lazy" alt="Locust result" src="https://mattefara.github.com/assets/images/locust-b785fc295fb10a6009618191199deb3d.png" width="1523" height="731" class="img_ev3q"></p>
<p>In this case, after three deployments caused by Wave, the request failures are at 0%.
Every time a new deployment is started, new Vault credentials are generated while the others do not expire immediately.</p>
<p>The API called is really simple, it just tests a database connection with every request.</p>
<div class="language-golang codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-golang codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rows, err := db.Queryx("SELECT pg_sleep($1)", pg_sleep)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          log.Panic(err)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  defer rows.Close()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fmt.Fprintf(w, "Ok")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">})</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusions">Conclusions<a href="https://mattefara.github.com/blog/Wave/#conclusions" class="hash-link" aria-label="Direct link to Conclusions" title="Direct link to Conclusions">​</a></h2>
<p>Using this method, it is possible to integrate dynamic secrets using Vault with applications that do not support it. This increases complexity because two new tools, ESO and Wave, come into play. However, the maintenance appears to be relatively simple.</p>
<p>The test conducted with Locust is not a performance test; it merely checks if the solution works. The standard deployment uses three replicas for the tested application, showing good results with no connection errors.</p>
<p>If the number of replicas decreases, there are some connection errors, but they are less than 1% during the load of 1000 RPS. Nevertheless, the application attempts to shut down gracefully, terminating connections before closing down.</p>]]></content:encoded>
            <category>kubernetes</category>
            <category>eso</category>
            <category>vault</category>
            <category>wave</category>
        </item>
        <item>
            <title><![CDATA[Welcome]]></title>
            <link>https://mattefara.github.com/blog/welcome/</link>
            <guid>https://mattefara.github.com/blog/welcome/</guid>
            <pubDate>Thu, 22 Feb 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[This marks the beginning of my journey through the exploration of new technologies. I'm an Italian guy passionate about technology and eager to explore new things.]]></description>
            <content:encoded><![CDATA[<p>This marks the beginning of my journey through the exploration of new technologies. I'm an Italian guy passionate about technology and eager to explore new things.</p>
<p>Whenever I come across something I find interesting, I will try it out and share my thoughts here.</p>
<p>I hope this project can help me grow both professionally and mentally, allowing me to expand my knowledge.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-not-medium">Why not Medium?<a href="https://mattefara.github.com/blog/welcome/#why-not-medium" class="hash-link" aria-label="Direct link to Why not Medium?" title="Direct link to Why not Medium?">​</a></h2>
<p>I have nothing against Medium or similar sites. However, I prefer to maintain my own site so that I have full control over it. For now, I'm using Github Pages to avoid managing a server, but we'll see what the future holds.</p>
<p>Having a website can help me better track my achievements and accomplishments while also improving my English skills. Currently, everything is powered by <a href="https://docusaurus.io/" target="_blank" rel="noopener noreferrer">Docusaurus</a>.</p>
<p>This is my first time doing something like this, and I'm excited!</p>]]></content:encoded>
            <category>docusaurus</category>
        </item>
    </channel>
</rss>