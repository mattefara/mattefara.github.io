---
sidebar_position: 2
---

# Cluster setup
At the moment the server is an old single machine which runs Proxmox.

Inside Proxmox there are two VMs:
- Kubernetes node (k3s)
- DNS server (Pihole)

At the moment everything is installed through Kubernetes without any other tool like Docker Compose.

There is a DNS server used for Ingress routing and it lives only inside the LAN, so that the cluster can remain private.

## Kubernetes installation
K3s is the Kubernetes distribution chosen for my homelab because the resources are very limited and K3s in known to be lightweight.

For starter, the cluster is installed using the utility script in the docs:
```bash
curl -sfL https://get.k3s.io | sh -
```

At the moment the cluster is in a single node installation with the default CNI and Ingress controller (Traefik).

After the installation is done, the YAML config can be exported from the node and used in the remote machine with `kubectl`.

## Maintainability
The cluster updates and maintainability are done using [automated upgrades](https://docs.k3s.io/upgrades/automated) through the system-upgrade-controller and k3s-upgrade.

## Ingress and external access
Applicationn needs can change the usage and exposore of Ingress.
Normally, the endpoint are private, meaning that they are eccessible only through the LAN.
This can be done using a DNS server inside the local network.
This can done using [Pihole](https://pi-hole.net/).
The service in installed as Docker container in another VM on Proxmox. This VM exposes a private IP address so that a local computer can use it to resolve hosts.

### DNS autoconfiguration
Every Ingress resource is exposed inside the local network. 
This can be done automatically by the [external-dns](https://github.com/kubernetes-sigs/external-dns) and can be configured with Pihole. 
After the installation using Helm, it can be configured with the admin token generated by Pihole, so that the pod can interact with the Pihole REST APIs, adding DNS records as needed.

The DNS record create policy used in Pihole is upsert: when a new Ingress resource is processed it add a new DNS record but when it is deleted it remains on Pihole.
With this strategy other DNS records defined outside Kubernetes can live on the DNS server.

If the Pihole is set to be the default DNS through the router, the DNS records can be resolved by the machines inside the LAN.

In the future is planned to test a solution that uses two external-dns, with for Pihole, and the other with external services like, for example, Cloudflare so that some applications can be available plublicly.
