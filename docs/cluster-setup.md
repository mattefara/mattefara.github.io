---
sidebar_position: 2
---

# Cluster Setup
Currently, the server is an old single machine running Proxmox.

Inside Proxmox, there are two VMs:
- Kubernetes node (k3s)
- DNS server (Pi-hole)

Currently, everything is installed through Kubernetes (except Pi-hole) without the need for additional tools like Docker Compose.

A DNS server is utilized for Ingress routing, residing solely within the LAN to maintain cluster privacy with Pi-hole.

## Kubernetes Installation
K3s is the chosen Kubernetes distribution for my homelab due to its lightweight nature, ideal for limited resources.

To initiate the cluster, use the utility script in the docs:
```bash
curl -sfL https://get.k3s.io | sh -
```

The cluster is currently a single-node installation with default CNI and Ingress controller (Traefik). After installation, the YAML config can be exported from the node and utilized on remote machines with `kubectl`.

## Maintainability
Cluster updates and maintenance are automated through [automated upgrades](https://docs.k3s.io/upgrades/automated) via the system-upgrade-controller and k3s-upgrade.

## Ingress and External Access
Application needs may necessitate changes in Ingress usage and exposure. Typically, endpoints are private, accessible only within the LAN. This setup is facilitated by a DNS server within the local network, specifically [Pi-hole](https://pi-hole.net/), deployed as a Docker container on another VM within Proxmox. This VM exposes a private IP address, enabling local computers to resolve hosts.

### DNS Autoconfiguration
Every Ingress resource is exposed within the local network. This is achieved automatically through [external-dns](https://github.com/kubernetes-sigs/external-dns), configurable with Pi-hole. Upon installation via Helm, it can be configured with the admin token generated by Pi-hole, enabling the pod to interact with Pi-hole REST APIs, adding DNS records as required.

The DNS record creation policy used in Pi-hole is "upsert": when a new Ingress resource is processed, a new DNS record is added, but if it's deleted, it remains in Pi-hole. This strategy allows other DNS records defined outside Kubernetes to coexist on the DNS server.

If Pi-hole is set as the default DNS through the router, machines within the LAN can resolve DNS records.

In the future, a solution will be tested using two external-dns instances, one for Pi-hole and the other for external services like Cloudflare, enabling some applications to be publicly available.

